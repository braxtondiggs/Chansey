name: CI Branch
on:
  push:
    branches-ignore:
      - master
  pull_request:
    branches-ignore:
      - master

# Needed for nx-set-shas
permissions:
  actions: read
  contents: read

jobs:
  branch-workflow:
    name: Other Branch Workflow
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - name: Install dependencies (verifies lockfile integrity)
        run: npm ci --prefer-offline --no-audit
        # Using 'npm ci' ensures:
        # - package-lock.json matches package.json exactly
        # - Reproducible builds across environments
        # - Faster installation (skips dependency resolution)
        # - Fails if lockfile is out of sync
      - uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'master'

      # NOTE: Nx Cloud DTE disabled - was causing 5x slowdown (10min vs 2min for tests)
      # - name: Start Nx Cloud DTE agents
      #   run: npx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

      - name: Lint affected projects
        run: npx nx affected --target=lint --parallel=3

      - name: Test affected projects
        run: npx nx affected --target=test --parallel=3 --configuration=ci

      - name: Build affected projects (development)
        run: npx nx affected --target=build --configuration=development --parallel=3

      # TODO: Enable after fixing existing circular dependencies (27 found)
      # - name: Check for circular dependencies
      #   run: npm run deps:circular
