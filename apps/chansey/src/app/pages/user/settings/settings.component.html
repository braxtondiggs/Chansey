<p-card class="tabs">
  <p-tabs value="0" scrollable>
    <p-tablist>
      <p-tab value="0"><i class="pi pi-palette mr-2"></i>Appearance</p-tab>
      <p-tab value="1"><i class="pi pi-bell mr-2"></i>Notification</p-tab>
      <p-tab value="2"><i class="pi pi-shield mr-2"></i> Privacy & Security</p-tab>
      <p-tab value="3"><i class="pi pi-chart-line mr-2"></i>Trading</p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <p-panel header="Color Scheme" [toggleable]="true" class="mt-3">
          <div class="flex flex-col gap-4">
            <div class="flex flex-row items-center justify-between py-3">
              <span class="text-lg font-semibold">Dark Mode</span>
              <p-toggleswitch class="mt-2 block" [(ngModel)]="darkMode" (ngModelChange)="toggleDarkMode()" />
            </div>

            <div class="flex flex-row items-center justify-between py-3">
              <span class="text-lg font-semibold">App Theme</span>
              <p-selectbutton
                class="mt-2 block"
                [options]="presets"
                [(ngModel)]="selectedPreset"
                (ngModelChange)="onPresetChange($event)"
                [allowEmpty]="false"
              />
            </div>

            <div class="flex flex-row items-center justify-between py-3">
              <span class="text-lg font-semibold">Card Style</span>
              <p-selectbutton
                class="mt-2 block md:mt-0"
                [(ngModel)]="cardStyle"
                (ngModelChange)="onCardStyleChange($event)"
                [options]="cardStyleOptions"
                optionLabel="name"
                optionValue="value"
                [allowEmpty]="false"
              />
            </div>

            <div class="mb-4 flex flex-col items-start py-3">
              <span class="mb-2 text-lg font-semibold">Theme Color:</span>
              <div class="flex max-w-full flex-wrap gap-2 pt-2 pr-0 md:max-w-lg md:pr-48">
                @for (primaryColor of primaryColors; track trackByName($index, primaryColor)) {
                  <button
                    type="button"
                    [title]="primaryColor.name"
                    (click)="updateColors($event, 'primary', primaryColor)"
                    class="flex h-6 w-6 cursor-pointer items-center justify-center rounded duration-150 hover:shadow-lg"
                    [style]="{
                      'background-color':
                        primaryColor?.name === 'noir' ? 'var(--text-color)' : primaryColor?.palette?.['500']
                    }"
                  >
                    @if (primaryColor.name === selectedPrimaryColor) {
                      <i class="pi pi-check text-white"></i>
                    }
                  </button>
                }
              </div>
            </div>

            <div>
              <span class="mb-2 text-lg font-semibold">Surface Color:</span>
              <div class="flex max-w-full flex-wrap gap-2 pt-2 pr-0 md:max-w-lg md:pr-48">
                @for (surface of surfaces; track trackByName($index, surface)) {
                  <button
                    type="button"
                    [title]="surface.name"
                    (click)="updateColors($event, 'surface', surface)"
                    class="flex h-6 w-6 cursor-pointer items-center justify-center rounded duration-150 hover:shadow-lg"
                    [style]="{
                      'background-color': surface?.palette?.['500']
                    }"
                  >
                    @if (
                      selectedSurfaceColor
                        ? selectedSurfaceColor === surface.name
                        : darkMode
                          ? surface.name === 'zinc'
                          : surface.name === 'slate'
                    ) {
                      <i class="pi pi-check text-white"></i>
                    }
                  </button>
                }
              </div>
            </div>
          </div>
        </p-panel>

        <p-panel header="Menu Settings" [toggleable]="true" class="mt-3">
          <div class="flex flex-col gap-4">
            <div class="flex flex-row items-center justify-between py-3">
              <span class="text-lg font-semibold">Menu Theme</span>
              <p-selectbutton
                class="mt-2 block md:mt-0"
                [(ngModel)]="menuTheme"
                (ngModelChange)="onMenuThemeChange($event)"
                [options]="menuThemeOptions"
                optionLabel="name"
                optionValue="value"
                [allowEmpty]="false"
              />
            </div>

            <div class="flex flex-col justify-between py-3 md:flex-row md:items-center">
              <span class="text-lg font-semibold">Menu Type</span>
              <div class="flex w-64 flex-col flex-wrap gap-3 pt-2">
                <div class="flex">
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="static"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('static')"
                      inputId="static"
                    />
                    <label for="static">Static</label>
                  </div>

                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="overlay"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('overlay')"
                      inputId="overlay"
                    />
                    <label for="overlay">Overlay</label>
                  </div>
                </div>
                <div class="flex">
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="slim"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('slim')"
                      inputId="slim"
                    />
                    <label for="slim">Slim</label>
                  </div>
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="compact"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('compact')"
                      inputId="compact"
                    />
                    <label for="compact">Compact</label>
                  </div>
                </div>
                <div class="flex">
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="reveal"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('reveal')"
                      inputId="reveal"
                    />
                    <label for="reveal">Reveal</label>
                  </div>
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="drawer"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('drawer')"
                      inputId="drawer"
                    />
                    <label for="drawer">Drawer</label>
                  </div>
                </div>
                <div class="flex">
                  <div class="flex w-6/12 items-center gap-2">
                    <p-radiobutton
                      name="menuMode"
                      value="horizontal"
                      [(ngModel)]="menuMode"
                      (ngModelChange)="setMenuMode('horizontal')"
                      inputId="horizontal"
                    />
                    <label for="horizontal">Horizontal</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-panel>
      </p-tabpanel>

      <p-tabpanel value="1">
        <p-panel header="General" [toggleable]="true">
          <form [formGroup]="notificationForm">
            <h3 class="text-md mr-1 mb-3 text-right font-semibold">Push</h3>
            <div class="flex flex-row justify-between py-3">
              <div class="mb-2 md:mb-0">
                <div class="text-900 mb-1 text-lg font-semibold">Account Updates</div>
                <div class="text-600 text-sm">Receive notifications for account-related activities</div>
              </div>
              <p-toggleswitch formControlName="pushNotifications" class="mt-2 md:mt-0"></p-toggleswitch>
            </div>
          </form>
        </p-panel>
      </p-tabpanel>

      <p-tabpanel value="2">
        <p-panel header="Security Settings" [toggleable]="false">
          <form [formGroup]="securityForm">
            <div class="flex flex-row justify-between py-3">
              <div class="mb-2 md:mb-0">
                <div class="text-900 mb-1 text-lg font-semibold">Two-Factor Authentication</div>
                <div class="text-600 text-sm">Add an extra layer of security to your account</div>
              </div>
              <p-toggleswitch
                formControlName="twoFactorAuth"
                (onChange)="toggleTwoFactorAuth($event)"
                class="mt-2 md:mt-0"
              />
            </div>
          </form>
        </p-panel>
      </p-tabpanel>

      <p-tabpanel value="3">
        <form [formGroup]="opportunitySellingForm">
          <p-panel header="Opportunity Selling" [toggleable]="false">
            <div class="flex flex-row justify-between py-3">
              <div class="mb-2 md:mb-0">
                <div class="text-900 mb-1 text-lg font-semibold">Enable Opportunity Selling</div>
                <div class="text-600 text-sm">
                  When a strong buy opportunity appears but you don't have enough cash, the system can automatically
                  sell your weakest-performing positions to fund the purchase.
                </div>
              </div>
              <p-toggleswitch
                formControlName="enabled"
                (onChange)="toggleOpportunitySelling($event)"
                class="mt-2 md:mt-0"
              />
            </div>
          </p-panel>

          @if (opportunitySellingForm.get('enabled')?.value) {
            <p-panel header="Configuration" [toggleable]="true" class="mt-3">
              <div class="flex flex-col gap-6">
                <!-- Protected Coins -->
                <div class="flex flex-col gap-2">
                  <label class="text-900 font-semibold">Never Sell These Coins</label>
                  <p-autocomplete
                    formControlName="protectedCoins"
                    [multiple]="true"
                    [suggestions]="protectedCoinSuggestions"
                    (completeMethod)="searchProtectedCoins($event)"
                    optionLabel="name"
                    placeholder="Search for a coin..."
                    class="w-full"
                  >
                    <ng-template #item let-coin>
                      <div class="flex items-center gap-2">
                        @if (coin.image) {
                          <img [src]="coin.image" [alt]="coin.name" class="h-5 w-5 rounded-full" />
                        }
                        <span>{{ coin.name }}</span>
                        <span class="text-surface-500 text-xs uppercase">{{ coin.symbol }}</span>
                      </div>
                    </ng-template>
                  </p-autocomplete>
                  <span class="text-600 text-xs">These coins will never be sold, even if they are underperforming</span>
                </div>

                <!-- Max Liquidation -->
                <div class="flex flex-col gap-2">
                  <div class="flex items-center justify-between">
                    <label class="text-900 font-semibold">Max Sell Limit</label>
                    <span class="text-primary font-semibold"
                      >{{ opportunitySellingForm.get('maxLiquidationPercent')?.value }}%</span
                    >
                  </div>
                  <p-slider formControlName="maxLiquidationPercent" [min]="1" [max]="100" [step]="1" />
                  <span class="text-600 text-xs"
                    >The most of your portfolio that can be sold at once to fund a new opportunity</span
                  >
                </div>

                <!-- Save Button -->
                <div class="flex justify-end pt-2">
                  <p-button
                    label="Save"
                    icon="pi pi-save"
                    [loading]="updateOpportunitySellingMutation.isPending()"
                    (click)="saveOpportunitySelling()"
                  />
                </div>
              </div>
            </p-panel>
          }
        </form>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</p-card>

<!-- Password Dialog for Disabling 2FA -->
<p-dialog
  header="Confirm Password"
  [visible]="showPasswordDialog()"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '400px' }"
  (onHide)="cancelDisable2FA()"
>
  <div class="flex flex-col gap-4">
    <p class="text-surface-600 text-sm">Please enter your password to disable two-factor authentication.</p>
    <p-floatlabel variant="on" class="w-full">
      <p-password
        [(ngModel)]="disablePassword"
        [feedback]="false"
        [toggleMask]="true"
        [fluid]="true"
        size="large"
        autocomplete="current-password"
      />
      <label>Password</label>
    </p-floatlabel>
  </div>
  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button severity="secondary" (click)="cancelDisable2FA()">Cancel</p-button>
      <p-button severity="danger" [loading]="disableOtpMutation.isPending()" (click)="confirmDisable2FA()">
        Disable 2FA
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
