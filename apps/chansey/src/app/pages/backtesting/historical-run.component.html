<p-toast></p-toast>

<div class="grid gap-4">
  <p-card header="Launch Historical Backtest" class="launch-card">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-grid">
      <p-floatLabel>
        <input pInputText formControlName="name" placeholder="Enter a name" />
        <label for="name">Run Name</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-select
          formControlName="algorithmId"
          [options]="algorithms()"
          optionLabel="name"
          optionValue="id"
          [loading]="algorithmsLoading()"
          placeholder="Select algorithm"
        ></p-select>
        <label for="algorithmId">Algorithm</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-select
          formControlName="marketDataSetId"
          [options]="datasets()"
          optionLabel="label"
          optionValue="id"
          [loading]="datasetsLoading()"
          placeholder="Select dataset"
        ></p-select>
        <label for="marketDataSetId">Market Data Set</label>
      </p-floatLabel>

      <div class="inline-fields">
        <p-floatLabel>
          <p-inputNumber
            formControlName="initialCapital"
            mode="currency"
            currency="USD"
            [useGrouping]="true"
          ></p-inputNumber>
          <label for="initialCapital">Initial Capital</label>
        </p-floatLabel>

        <p-floatLabel>
          <p-inputNumber
            formControlName="tradingFee"
            mode="decimal"
            [minFractionDigits]="3"
            [maxFractionDigits]="5"
          ></p-inputNumber>
          <label for="tradingFee">Trading Fee</label>
        </p-floatLabel>
      </div>

      <p-floatLabel>
        <input pInputText formControlName="deterministicSeed" placeholder="Optional seed" />
        <label for="deterministicSeed">Deterministic Seed (optional)</label>
      </p-floatLabel>

      <button
        pButton
        type="submit"
        label="Queue Backtest"
        [loading]="isSubmitting()"
        [disabled]="form.invalid"
      ></button>
    </form>

    <ng-container *ngIf="form.value.marketDataSetId">
      <div class="dataset-meta" *ngIf="datasets().length">
        <ng-container *ngFor="let dataset of datasets()">
          <div *ngIf="dataset.id === form.value.marketDataSetId" class="meta-grid">
            <div>
              <span class="meta-label">Timeframe:</span>
              <span>{{ dataset.timeframe }}</span>
            </div>
            <div>
              <span class="meta-label">Range:</span>
              <span>{{ dataset.startAt | date: 'mediumDate' }} → {{ dataset.endAt | date: 'mediumDate' }}</span>
            </div>
            <div>
              <span class="meta-label">Universe:</span>
              <span>{{ dataset.instrumentUniverse.join(', ') }}</span>
            </div>
          </div>
        </ng-container>
      </div>
    </ng-container>
  </p-card>

  <p-card header="Historical Runs" class="runs-card">
    <p-table
      [value]="historicalRuns()"
      [loading]="backtestsLoading()"
      dataKey="id"
      [paginator]="true"
      [rows]="10"
      (onRowSelect)="onSelectRun($event.data)"
      selectionMode="single"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Name</th>
          <th>Algorithm</th>
          <th>Dataset</th>
          <th>Status</th>
          <th>Return</th>
          <th>Sharpe</th>
          <th>Created</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-run>
        <tr [pSelectableRow]="run">
          <td>{{ run.name }}</td>
          <td>{{ run.algorithm?.name || run.algorithm?.id }}</td>
          <td>{{ run.marketDataSet?.label || '—' }}</td>
          <td>
            <p-tag [value]="run.status" [severity]="statusSeverity(run.status)"></p-tag>
          </td>
          <td>
            <span *ngIf="run.totalReturn !== undefined; else pending">{{ run.totalReturn | percent: '1.0-2' }}</span>
          </td>
          <td>
            <span *ngIf="run.sharpeRatio !== undefined; else pending">{{ run.sharpeRatio | number: '1.2-2' }}</span>
          </td>
          <td>{{ run.createdAt | date: 'short' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<ng-template #pending>
  <span class="muted">—</span>
</ng-template>
