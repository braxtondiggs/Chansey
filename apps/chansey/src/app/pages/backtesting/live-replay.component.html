<p-messages
  severity="warn"
  [value]="[{ summary: 'Simulation Only', detail: 'Live replay runs do not touch exchanges.' }]"
></p-messages>

<div class="grid gap-4">
  <p-card header="Launch Live Replay" class="launch-card">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-grid">
      <p-floatLabel>
        <input pInputText formControlName="name" placeholder="Live replay name" />
        <label for="name">Replay Name</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-select
          formControlName="algorithmId"
          [options]="algorithms()"
          optionLabel="name"
          optionValue="id"
          [loading]="algorithmsQuery.isPending()"
          placeholder="Select algorithm"
        ></p-select>
        <label for="algorithmId">Algorithm</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-select
          formControlName="marketDataSetId"
          [options]="replayDatasets()"
          optionLabel="label"
          optionValue="id"
          [loading]="datasetsQuery.isPending()"
          placeholder="Select replay dataset"
        ></p-select>
        <label for="marketDataSetId">Replay Dataset</label>
      </p-floatLabel>

      <div class="inline-fields">
        <p-floatLabel>
          <p-inputNumber
            formControlName="initialCapital"
            mode="currency"
            currency="USD"
            [useGrouping]="true"
          ></p-inputNumber>
          <label for="initialCapital">Initial Capital</label>
        </p-floatLabel>

        <p-floatLabel>
          <p-inputNumber
            formControlName="tradingFee"
            mode="decimal"
            [minFractionDigits]="4"
            [maxFractionDigits]="5"
          ></p-inputNumber>
          <label for="tradingFee">Trading Fee</label>
        </p-floatLabel>
      </div>

      <p-floatLabel>
        <input pInputText formControlName="deterministicSeed" placeholder="Optional seed" />
        <label for="deterministicSeed">Deterministic Seed</label>
      </p-floatLabel>

      <button
        pButton
        type="submit"
        label="Queue Live Replay"
        [loading]="isSubmitting()"
        [disabled]="form.invalid"
      ></button>
    </form>
  </p-card>

  <p-card header="Live Replay Runs" class="runs-card">
    <p-table
      [value]="replayRuns()"
      [loading]="isLoading()"
      dataKey="id"
      selectionMode="single"
      (onRowSelect)="onSelectRun($event.data)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Name</th>
          <th>Dataset</th>
          <th>Status</th>
          <th>Return</th>
          <th>Last Updated</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-run>
        <tr [pSelectableRow]="run">
          <td>{{ run.name }}</td>
          <td>{{ run.marketDataSet?.label || 'â€”' }}</td>
          <td><p-tag [value]="run.status" [severity]="statusSeverity(run.status)"></p-tag></td>
          <td>{{ run.totalReturn | percent: '1.0-2' }}</td>
          <td>{{ run.updatedAt || run.createdAt | date: 'short' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-card *ngIf="selectedRun()" header="Telemetry Stream" class="telemetry-card">
    <p-timeline [value]="telemetryEvents()" align="alternate" styleClass="customized-timeline">
      <ng-template pTemplate="content" let-event>
        <p-tag [value]="event.scope"></p-tag>
        <pre>{{ event.payload | json }}</pre>
      </ng-template>
      <ng-template pTemplate="opposite" let-event>
        {{ event.timestamp | date: 'shortTime' }}
      </ng-template>
    </p-timeline>
  </p-card>
</div>
