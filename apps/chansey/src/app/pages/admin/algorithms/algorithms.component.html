<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-card>
  <p-table
    #dt
    [loading]="isLoading()"
    [paginator]="true"
    [rowHover]="true"
    [rows]="15"
    [showCurrentPageReport]="true"
    [selection]="selectedAlgorithms()"
    (selectionChange)="onSelectionChange($event)"
    [value]="algorithms()"
    [globalFilterFields]="['name', 'description', 'category']"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    dataKey="id"
    size="small"
    stripedRows
  >
    <ng-template #caption>
      <div class="m-4 flex flex-col gap-4 md:mx-0 md:mt-0 md:flex-row md:items-center md:justify-between">
        <div class="flex gap-4">
          <p-button
            label="New"
            [raised]="true"
            icon="pi pi-plus"
            severity="success"
            (onClick)="openNewAlgorithmDrawer()"
          />
          <p-button
            severity="danger"
            label="Delete"
            icon="pi pi-trash"
            outlined
            (onClick)="deleteSelectedAlgorithms()"
            [disabled]="!selectedAlgorithms() || !selectedAlgorithms().length"
            class="hidden md:inline-flex"
          />
        </div>
        <p-iconfield>
          <p-inputicon class="pi pi-search" />
          <input
            pInputText
            #searchInput
            type="text"
            (input)="applyGlobalFilter($event)"
            placeholder="Search..."
            class="w-full md:w-auto"
          />
        </p-iconfield>
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th style="width: 4rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="name" style="min-width: 12rem">Name <p-sortIcon field="name"></p-sortIcon></th>
        <th style="min-width: 10rem">Description</th>
        <th pSortableColumn="category" style="min-width: 8rem">Category <p-sortIcon field="category"></p-sortIcon></th>
        <th pSortableColumn="status" style="min-width: 8rem">Status <p-sortIcon field="status"></p-sortIcon></th>
        <th pSortableColumn="hasStrategy" style="min-width: 8rem">
          Strategy <p-sortIcon field="hasStrategy"></p-sortIcon>
        </th>
        <th pSortableColumn="weight" style="min-width: 6rem">Score <p-sortIcon field="weight"></p-sortIcon></th>
        <th style="width: 8rem">Actions</th>
      </tr>
    </ng-template>

    <ng-template #body let-algorithm>
      <tr>
        <td>
          <p-tableCheckbox [value]="algorithm"></p-tableCheckbox>
        </td>
        <td>
          <a class="text-primary cursor-pointer font-medium hover:underline" (click)="viewAlgorithm(algorithm)">
            {{ algorithm.name }}
          </a>
        </td>
        <td>
          <div class="line-clamp-2 overflow-x-hidden text-sm">{{ algorithm.description || '-' }}</div>
        </td>
        <td>
          <p-tag [value]="getCategoryLabel(algorithm.category)" severity="info"></p-tag>
        </td>
        <td>
          <p-tag [value]="getStatusLabel(algorithm.status)" [severity]="getStatusSeverity(algorithm.status)"></p-tag>
        </td>
        <td>
          @if (algorithm.hasStrategy) {
            <p-tag value="Linked" severity="success" icon="pi pi-check"></p-tag>
          } @else {
            <p-tag value="None" severity="secondary"></p-tag>
          }
        </td>
        <td>{{ algorithm.weight !== null && algorithm.weight !== undefined ? algorithm.weight + '/10' : '-' }}</td>
        <td>
          <div class="flex gap-1">
            <p-button
              icon="pi pi-eye"
              severity="info"
              [rounded]="true"
              [outlined]="true"
              (onClick)="viewAlgorithm(algorithm)"
              pTooltip="View Details"
            />
            <p-button
              icon="pi pi-pencil"
              severity="secondary"
              [rounded]="true"
              [outlined]="true"
              (onClick)="openEditAlgorithmDrawer(algorithm)"
              pTooltip="Edit"
            />
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [rounded]="true"
              [outlined]="true"
              (onClick)="confirmDeleteAlgorithm(algorithm)"
              pTooltip="Delete"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="8">No algorithms found.</td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Shared Edit Drawer -->
<app-algorithm-edit-drawer
  #editDrawer
  [algorithm]="editingAlgorithm()"
  [strategies]="strategies()"
  [isLoading]="isSavePending()"
  (save)="onDrawerSave($event)"
></app-algorithm-edit-drawer>
