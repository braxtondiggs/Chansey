<p-toast></p-toast>
<p-card>
  <!-- Loading skeleton -->
  @if (isLoading) {
    <div class="mb-4">
      <!-- Skeleton for search input -->
      <div class="mb-4 flex flex-col items-end">
        <div class="w-full max-w-xs">
          <p-skeleton width="100%" height="2.75rem" class="rounded-md"></p-skeleton>
        </div>
      </div>
      <!-- Skeleton table wrapper with responsive overflow -->
      <div class="overflow-x-auto">
        <!-- Skeleton for table header -->
        <div
          class="flex w-full min-w-[800px] border-b border-gray-200 bg-gray-50 p-3 md:min-w-0 dark:border-gray-700 dark:bg-gray-800"
        >
          @if (config.showWatchlistToggle || config.showRemoveAction) {
            <div class="mr-4 w-10 flex-shrink-0">
              <p-skeleton width="100%" height="1.25rem"></p-skeleton>
            </div>
          }
          <div class="mr-6 min-w-48 flex-1 flex-shrink-0">
            <p-skeleton width="80%" height="1.25rem"></p-skeleton>
          </div>
          <div class="mr-6 w-28 flex-shrink-0">
            <p-skeleton width="100%" height="1.25rem"></p-skeleton>
          </div>
          <div class="mr-6 w-32 flex-shrink-0">
            <p-skeleton width="100%" height="1.25rem"></p-skeleton>
          </div>
          <div class="mr-6 w-32 flex-shrink-0">
            <p-skeleton width="100%" height="1.25rem"></p-skeleton>
          </div>
          <div class="mr-6 w-44 flex-shrink-0">
            <p-skeleton width="100%" height="1.25rem"></p-skeleton>
          </div>
          <div class="w-24 flex-shrink-0">
            <p-skeleton width="100%" height="1.25rem"></p-skeleton>
          </div>
        </div>
        <!-- Skeleton for table rows -->
        @for (i of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; track i) {
          <div class="flex min-w-[800px] border-b border-gray-200 p-3 md:min-w-0 dark:border-gray-700">
            <!-- Action button skeleton -->
            @if (config.showWatchlistToggle || config.showRemoveAction) {
              <p-skeleton width="40px" height="2.5rem" class="mr-4 flex-shrink-0 rounded-full"> </p-skeleton>
            }
            <!-- Coin name and image skeleton -->
            <div class="mr-6 flex min-w-48 flex-1 flex-shrink-0 items-center">
              <p-skeleton shape="circle" size="2.5rem" class="mr-3"></p-skeleton>
              <div class="flex flex-col">
                <p-skeleton width="120px" height="1.25rem" class="mb-1"></p-skeleton>
                <p-skeleton width="60px" height="1rem"></p-skeleton>
              </div>
            </div>
            <!-- Price skeleton -->
            <div class="mr-6 w-28 flex-shrink-0">
              <p-skeleton width="100%" height="1.25rem"></p-skeleton>
            </div>
            <!-- Market cap skeleton -->
            <div class="mr-6 w-32 flex-shrink-0">
              <p-skeleton width="100%" height="1.25rem"></p-skeleton>
            </div>
            <!-- Volume skeleton -->
            <div class="mr-6 w-32 flex-shrink-0">
              <p-skeleton width="100%" height="1.25rem"></p-skeleton>
            </div>
            <!-- Circulating supply skeleton -->
            <div class="mr-6 w-44 flex-shrink-0">
              <p-skeleton width="100%" height="1rem" class="mb-1"></p-skeleton>
              <p-skeleton width="80%" height="0.5rem"></p-skeleton>
            </div>
            <!-- 24h change skeleton -->
            <div class="w-24 flex-shrink-0">
              <p-skeleton width="100%" height="2rem" class="rounded-full"></p-skeleton>
            </div>
          </div>
        }
      </div>
      <!-- Skeleton for pagination -->
      <div class="mt-4 flex items-center justify-between overflow-x-hidden p-3">
        <p-skeleton width="200px" height="1.25rem"></p-skeleton>
        <div class="flex gap-2">
          <p-skeleton width="40px" height="2.5rem" class="rounded-md"></p-skeleton>
          <p-skeleton width="40px" height="2.5rem" class="rounded-md"></p-skeleton>
          <p-skeleton width="40px" height="2.5rem" class="rounded-md"></p-skeleton>
          <p-skeleton width="40px" height="2.5rem" class="rounded-md"></p-skeleton>
        </div>
      </div>
    </div>
  }

  <!-- Actual table content -->
  @if (!isLoading) {
    <p-table
      #dt
      [paginator]="true"
      [rowHover]="true"
      [rows]="25"
      [showCurrentPageReport]="true"
      [value]="sortedCoins()"
      [globalFilterFields]="['name']"
      [customSort]="true"
      (sortFunction)="customSort($event)"
      (onPage)="onPageChange($event)"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      dataKey="id"
      size="large"
      stripedRows
    >
      <ng-template #caption>
        <div class="flex flex-col items-end">
          <p-iconfield>
            <p-inputicon class="pi pi-search" />
            <input
              pInputText
              #searchInput
              type="text"
              (input)="applyGlobalFilter($event)"
              [placeholder]="config.searchPlaceholder"
              class="w-full md:w-auto"
            />
          </p-iconfield>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr class="whitespace-nowrap">
          @if (config.showWatchlistToggle || config.showRemoveAction) {
            <th></th>
          }
          <th pSortableColumn="name" class="min-w-48">Coin <p-sortIcon field="name" /></th>
          <th class="min-w-28 text-right">Price</th>
          <th pSortableColumn="marketCap" class="min-w-32 text-right">Market Cap <p-sortIcon field="marketCap" /></th>
          <th pSortableColumn="totalVolume" class="min-w-32 text-right">24h Vol <p-sortIcon field="totalVolume" /></th>
          <th pSortableColumn="circulatingSupply" class="min-w-44 text-center">
            Circulating Supply <p-sortIcon field="circulatingSupply" />
          </th>
          <th pSortableColumn="priceChangePercentage24h" class="min-w-24 text-center">
            24h % <p-sortIcon field="priceChangePercentage24h" />
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-coin let-ri="rowIndex">
        <tr>
          @if (config.showWatchlistToggle || config.showRemoveAction) {
            <td class="!p-0 !pl-2">
              <!-- Watchlist toggle button -->
              @if (config.showWatchlistToggle) {
                <p-button
                  [loading]="isCoinProcessing(coin.id)"
                  [icon]="isInWatchlist(coin.id) ? 'pi pi-star-fill' : 'pi pi-star'"
                  [rounded]="true"
                  [text]="true"
                  size="large"
                  severity="warn"
                  (click)="onToggleWatchlist(coin)"
                  [disabled]="isCoinProcessing(coin.id)"
                  pTooltip="{{ isInWatchlist(coin.id) ? 'Remove from watchlist' : 'Add to watchlist' }}"
                  tooltipPosition="top"
                />
              }
              <!-- Remove button -->
              @if (config.showRemoveAction) {
                <p-button
                  [loading]="isCoinProcessing(coin.id)"
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  size="large"
                  severity="danger"
                  (click)="onRemoveCoin(coin)"
                  [disabled]="isCoinProcessing(coin.id)"
                  pTooltip="Remove from watchlist"
                  tooltipPosition="top"
                />
              }
            </td>
          }
          <td class="min-w-48" [class.!pl-0]="config.showWatchlistToggle || config.showRemoveAction">
            <a
              [routerLink]="['/app/coins', coin.slug]"
              class="flex items-center gap-3 transition-opacity hover:opacity-80"
            >
              <p-avatar [image]="coin.image" shape="circle" size="large" class="min-w-10 shadow-sm" />
              <div class="flex flex-col">
                <span class="text-primary-500 hover:text-primary-600 text-lg font-medium">{{ coin.name }}</span>
                <span class="text-sm text-gray-500 uppercase dark:text-gray-400">{{ coin.symbol }}</span>
              </div>
            </a>
          </td>
          <td class="min-w-28 text-right font-medium">
            @if (!isLoadingPrices()(coin.slug)) {
              <span [appCounter]="getCoinPrice()(coin.slug)"></span>
            }
            @if (isLoadingPrices()(coin.slug)) {
              <p-skeleton width="60px" height="1.25rem" class="inline-block" />
            }
          </td>
          <td class="min-w-32 text-right">{{ coin.marketCap | formatLargeNumber }}</td>
          <td class="min-w-32 text-right">{{ coin.totalVolume | formatLargeNumber }}</td>
          <td class="min-w-44 text-center">
            @if (coin.maxSupply) {
              <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                  <span>{{ coin.circulatingSupply | number: '1.0-0' }}</span>
                  <span>{{ coin.maxSupply | number: '1.0-0' }}</span>
                </div>
                <p-progressBar
                  [value]="(coin.circulatingSupply / coin.maxSupply) * 100"
                  [showValue]="false"
                  class="!h-2"
                />
              </div>
            } @else {
              <span>{{ coin.circulatingSupply | number: '1.0-0' }}</span>
            }
          </td>
          <td class="min-w-24 text-center">
            @if (coin.priceChangePercentage24h) {
              <p-tag [severity]="getTag(coin.priceChangePercentage24h)" [value]="coin.priceChangePercentage24h" />
            }
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="config.showWatchlistToggle || config.showRemoveAction ? 7 : 6" class="p-4 text-center">
            <div class="text-gray-500">
              @if (searchFilter()) {
                <i class="pi pi-search mr-2"></i>
                No coins found matching "{{ searchFilter() }}"
                <div class="mt-2 text-sm">
                  Try adjusting your search terms or
                  <button
                    type="button"
                    class="text-primary-500 hover:text-primary-600 underline"
                    (click)="clearSearch()"
                  >
                    clear the search
                  </button>
                </div>
              } @else {
                <i class="pi pi-info-circle mr-2"></i>
                {{ config.emptyMessage }}
              }
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</p-card>
